name: Build Arch Linux Package

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v0.3.0)'
        required: true
        type: string

env:
  CARGO_TERM_COLOR: always

jobs:
  build-arch-packages:
    name: Build Arch Package (${{ matrix.arch }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [x86_64, aarch64]
        include:
          - arch: x86_64
            target: x86_64-unknown-linux-gnu
          - arch: aarch64
            target: aarch64-unknown-linux-gnu

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install makepkg dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y fakeroot binutils

      - name: Build release binary
        run: |
          cargo build --release --target ${{ matrix.target }}
          strip target/${{ matrix.target }}/release/unifictl || true

      - name: Determine version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/}
          fi
          VERSION=${VERSION#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Update PKGBUILD
        run: |
          sed -i "s/^pkgver=.*/pkgver=${{ steps.version.outputs.version }}/" packaging/arch/PKGBUILD
          sed -i "s/^pkgrel=.*/pkgrel=1/" packaging/arch/PKGBUILD

      - name: Create package directory
        run: |
          mkdir -p pkg/usr/bin
          mkdir -p pkg/usr/share/doc/unifictl
          mkdir -p pkg/usr/share/licenses/unifictl

      - name: Install files
        run: |
          install -Dm755 target/${{ matrix.target }}/release/unifictl pkg/usr/bin/unifictl
          install -Dm644 README.md pkg/usr/share/doc/unifictl/README.md
          install -Dm644 LICENSE pkg/usr/share/licenses/unifictl/LICENSE

      - name: Create .PKGINFO
        run: |
          cat > pkg/.PKGINFO <<EOF
          pkgname = unifictl
          pkgver = ${{ steps.version.outputs.version }}-1
          pkgdesc = CLI for UniFi Site Manager (API v1/EA)
          url = https://github.com/nachtschatt3n/unifictl
          builddate = $(date +%s)
          packager = GitHub Actions <actions@github.com>
          size = $(du -sb pkg | cut -f1)
          arch = ${{ matrix.arch }}
          license = GPL-3.0
          depend = openssl
          depend = glibc
          EOF

      - name: Create .MTREE
        run: |
          cd pkg
          find . -type f -o -type d | sort | sed 's|^\./||' | while read line; do
            if [ -d "$line" ]; then
              echo "/$line type=dir"
            else
              MODE=$(stat -c %a "$line" 2>/dev/null || echo 644)
              SIZE=$(stat -c %s "$line" 2>/dev/null || echo 0)
              echo "/$line type=file mode=$MODE size=$SIZE"
            fi
          done > .MTREE
          cd ..

      - name: Create package archive
        run: |
          cd pkg
          tar czf ../unifictl-${{ steps.version.outputs.version }}-1-${{ matrix.arch }}.pkg.tar.zst .PKGINFO .MTREE usr/
          cd ..
          mv unifictl-${{ steps.version.outputs.version }}-1-${{ matrix.arch }}.pkg.tar.zst unifictl-${{ matrix.arch }}.pkg.tar.zst

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: unifictl-arch-${{ matrix.arch }}
          path: unifictl-${{ matrix.arch }}.pkg.tar.zst
          retention-days: 30
